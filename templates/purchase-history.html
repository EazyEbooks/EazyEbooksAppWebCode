<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="google-adsense-account" content="ca-pub-8875422219223826">
    <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/purchase_history.css') }}">
    <link rel="stylesheet" href="../static/css/home.css">
    <link rel="stylesheet" href="../static/css/responsive.css">
    <title>Purchase History</title>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8875422219223826"
     crossorigin="anonymous"></script>
</head>
<body>
    <div class="container">
        <main>
            <h1 class="purchase-history-heading">Purchase History</h1>
            {% with messages = get_flashed_messages() %}
                {% if messages %}
                    <ul class="flashes">
                        {% for message in messages %}
                            <li>{{ message }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}
            {% endwith %}
            <div class="purchase-flexed">
                <div class="purchase-history-section">
                    <h2>Ebooks</h2>
                    <table class="purchase-table">
                        <thead>
                            <tr>
                                <th>Ebook</th>
                                <th>Purchase Date</th>
                                <!-- <th>Expiry Date</th> -->
                                <th>Amount</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for ebook in library %}
                            <tr>
                                <td>{{ ebook.ebook }}</td>
                                <td>{{ ebook.purchase_date }}</td>
                                <!-- <td>{{ ebook.expiry_date }}</td> -->
                                <td>{{ ebook.amount }}</td>
                                <td>
                                    {% if ebook.refund %}
                                    <p>Refund already requested</p>
                                    {% elif ebook.accessed %}
                                    <p>Cannot be refunded as the ebook was accessed</p>
                                    {% elif (datetime.datetime.now() - datetime.datetime.strptime(ebook.purchase_date, '%Y-%m-%d')).days > 3 %}
                                    <p>Cannot request refund as it's been more than 3 days since purchase</p>
                                    {% else %}
                                    <form action="{{ url_for('purchase_history.RequestRefund', ebook=ebook.ebook) }}" method="POST">
                                        <button type="submit" class="btn-refund">Request Refund</button>
                                    </form>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="purchase-history-section">
                    <h2>Hard Copies</h2>
                    <table class="purchase-table">
                        <thead>
                            <tr>
                                <th>Ebook</th>
                                <th>Order Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in pending_orders %}
                            <tr>
                                <td>{{ order.ebook }}</td>
                                <td>{{ order.order_placement_date }}</td>
                                <td>{{ order.status }}</td>
                                <td>
                                    <button class="btn-details" onclick="toggleDetails('{{ order._id|string }}')">Details</button>
                                </td>
                            </tr>
                            <tr id="details-{{ order._id|string }}" class="order-details">
                                <td colspan="4">
                                    <div class="order-info">
                                        <p><strong>Full Name:</strong> {{ order.delivery_address.full_name }}</p>
                                        <p><strong>Email:</strong> {{ order.delivery_address.email_address }}</p>
                                        <p><strong>Mobile:</strong> {{ order.delivery_address.mobile_number }}</p>
                                        <p><strong>Address:</strong> {{ order.delivery_address.address }}</p>
                                        <p><strong>City:</strong> {{ order.delivery_address.city }}</p>
                                        <p><strong>State:</strong> {{ order.delivery_address.state }}</p>
                                        <p><strong>Status:</strong> {{ order.status }}</p>
                                        {% if order.refund_requested %}
                                        <p>Refund already requested</p>
                                        {% elif (datetime.datetime.now() - datetime.datetime.strptime(order.order_placement_date, '%Y-%m-%d')).days > 7 %}
                                        <p>Cannot request refund as it's been more than 7 days since delivery. In case of a valid reason for refund, please contact us personally.</p>
                                        {% else %}
                                        <form action="{{ url_for('purchase_history.RequestRefundHardCopy', order_id=order._id|string) }}" method="POST">
                                            <textarea name="refund_reason" placeholder="Reason for refund request" required></textarea>
                                            <button type="submit" class="btn-refund">Request Refund</button>
                                        </form>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
    <script>
        function toggleDetails(orderId) {
            var details = document.getElementById('details-' + orderId);
            if (details.style.display === 'none' || details.style.display === '') {
                details.style.display = 'table-row';
            } else {
                details.style.display = 'none';
            }
        }
    </script>
    <div class="bottom-navbar">
        <ul class="bottom-navbar-list">
            <li class="bottom-navbar-list-element">
                <a href="/" class="bottom-navbar-link"><ion-icon name="home-outline" class="bottom-nav-icon"></ion-icon></a>
            </li>
            <li class="bottom-navbar-list-element">
                <a href="/marketplace" class="bottom-navbar-link"><ion-icon name="cart-outline" class="bottom-nav-icon"></ion-icon></a>
            </li>
            <!-- <li class="bottom-navbar-list-element">
                <a href="" class="bottom-navbar-link"><ion-icon name="book-outline" class="bottom-nav-icon"></ion-icon></a>
            </li> -->
            <li class="bottom-navbar-list-element">
                <a href="/my-orders" class="bottom-navbar-link"><ion-icon name="list-outline" class="bottom-nav-icon"></ion-icon></a>
            </li>
            <li class="bottom-navbar-list-element">
                <a href="/purchase-history" class="bottom-navbar-link selected-bottom-nav-bar-link"><ion-icon name="cash-outline" class="bottom-nav-icon"></ion-icon></a>
            </li>
            <li class="bottom-navbar-list-element">
                <a href="/my-account/profile-settings" class="bottom-navbar-link"><ion-icon name="person-circle-outline" class="bottom-nav-icon"></ion-icon></a>
            </li>
        </ul>
    </div>
</body>
</html>
